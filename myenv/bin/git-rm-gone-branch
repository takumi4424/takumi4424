#!/bin/bash

function usage() {
    echo "usage: git list-rm-branch [--help]"
}

for arg in "$@"; do
    if [[ $arg =~ ^(-h|--help)$ ]]; then
        echo "Delete and display all branches removed from remote."
        echo "Run 'git remote prune origin' or 'git fetch/pull --prune' before running this."
        echo ""
        usage
        exit 0
    else
        echo "error: unknown argument '$arg'"
        usage
        exit 1
    fi
done

# リモートから削除されたブランチのリスト取得
branches_to_remove=()
while read -r line; do
    branches_to_remove+=("$line")
done < <(git list-gone-branch)
# リモートから削除されたブランチのリスト取得(現在のブランチを除く)
branches_to_remove2=()
while read -r line; do
    branches_to_remove2+=("$line")
done < <(git list-gone-branch --without-current)

if (( ${#branches_to_remove} != ${#branches_to_remove2} )); then
    # 現在のブランチもリモートから削除されたものであった場合
    echo 'You are currently checking out a branch that has probably been remotely deleted.'
    echo 'Once you have checked out the other branch, run this again.'
    exit 1
elif (( ${#branches_to_remove} == 0 )); then
    # 削除されるべきものがない場合
    echo 'None of the branches were deleted.'
    exit 0
fi

# ブランチの削除
git branch -D "${branches_to_remove[@]}"
